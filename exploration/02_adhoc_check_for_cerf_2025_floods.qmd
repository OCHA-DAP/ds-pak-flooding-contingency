```{r}
# one-off -----------------------------------------------------------------

#
#
# gdf_adm1 <- download_fieldmaps_sf(iso3="pak",layer = "pak_adm1")
# adm1_pcode <- gdf_adm1 |>
#   filter(ADM1_EN =="Khyber Pakhtunkhwa") |>
#   pull(ADM1_PCODE)
# con_prod <- cumulus::pg_con(stage= "prod")
# DBI:::dbListTables(con_prod)
# cumulus::pg_load_seas5_historical()
#
# df_imerg_adm1 <- dplyr::tbl(con_prod, "imerg") |>
#   filter(
#     adm_level ==1,
#     pcode ==adm1_pcode
#     ) |>
#   collect()
#
#
#
#   df_adm1_roll <- df_imerg_adm1 |>
#   rename(
#     `1d` = mean
#   ) |>
#   arrange( valid_date) |>
#   mutate(
#     `2d` = zoo::rollsum(x = `1d`, k = 2, fill = NA, align = "right"),
#     `3d` = zoo::rollsum(x = `1d`, k = 3, fill = NA, align = "right"),
#   ) |>
#   pivot_longer(
#     cols = c("1d", "2d", "3d"),names_to= "name",
#     values_to = "value"
#
#     )
#
#   df_adm1_thresh <- df_adm1_roll |>
#     mutate(
#       yr_date = floor_date(valid_date, "year")
#     ) |>
#     group_by(yr_date, name) |>
#     summarise(
#       value = max(value, na.rm = TRUE)
#     ) |>
#     grouped_quantile_summary(
#       x = "value",
#       grp_vars = c( "name"),
#       rps = 1:10
#     ) |>
#     filter(name == "3d",
#            rp ==5)
#
#
#   df_adm1_roll_filt <- df_adm1_roll |>
#     filter(
#       valid_date %in%     last_10_dates[-c(1,2)],
#       name == "3d"
#     )
#   df_adm1_roll_filt |>
#     ggplot(
#       aes(x= valid_date, y= value)
#     )+
#     geom_line()+
#     geom_point()+
#     geom_hline(yintercept = df_adm1_thresh$q_val,
#                color = hdx_hex("tomato-hdx"),
#                linetype = "dashed"
#     ) +
#     annotate(
#       geom = "text",
#       x = max(df_adm1_roll_filt$valid_date) - 2,
#       y = df_adm1_thresh$q_val + 5,
#       label = glue("Threshold (5 year RP value): {round(df_adm1_thresh$q_val,0)} mm"),
#       size = 6
#     ) +
#     scale_x_date(
#       date_breaks = "day", date_labels = "%b %d"
#     ) +
#     labs(
#       title = "Cumulative 3-day Precipitation",
#       subtitle = "Pakistan: Khyber Pakhtunkhwa Province",
#       y = "Precipitation (mm)",
#       caption = glue("Data source: IMERG\nProduced {Sys.Date()} ")
#     ) +
#     scale_y_continuous(limits = c(0, NA), expand = expansion(add = c(0, 10)))+
#     theme(
#       axis.title.x = element_blank(),
#       axis.title.y = element_text(size = 14),
#       axis.text.x = element_text(size = 14),
#       plot.title = element_text(size = 20),
#       plot.subtitle = element_text(size = 16)
#     )
#
#
#

```

